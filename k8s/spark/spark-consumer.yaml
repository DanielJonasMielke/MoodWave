# Spark Streaming Consumer Deployment
# Consumes from Kafka topics and writes to Supabase

apiVersion: v1
kind: Service
metadata:
  name: spark-metrics-service
  namespace: default
  labels:
    app: moodwave
    component: spark-consumer
spec:
  ports:
    - port: 4040
      targetPort: 4040
      name: metrics
  selector:
    app: moodwave
    component: spark-consumer

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: spark-consumer
  namespace: default
  labels:
    app: moodwave
    component: spark-consumer
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "4040"
    prometheus.io/path: "/metrics/prometheus"
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: moodwave
      component: spark-consumer
  template:
    metadata:
      labels:
        app: moodwave
        component: spark-consumer
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "4040"
        prometheus.io/path: "/metrics/prometheus"
    spec:
      containers:
        - name: spark-consumer
          image: joernjj/moodwave-spark:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 4040
              name: spark-ui
              protocol: TCP
          env:
            # Kafka configuration
            - name: KAFKA_BOOTSTRAP_SERVERS
              value: "kafka-service:9092"
            
            # Config file path
            - name: CONFIG_PATH
              value: "/app/config.yaml"
            
            # Supabase credentials from secrets
            - name: SUPABASE_URL
              valueFrom:
                secretKeyRef:
                  name: moodwave-secrets
                  key: SUPABASE_URL
            - name: SUPABASE_KEY
              valueFrom:
                secretKeyRef:
                  name: moodwave-secrets
                  key: SUPABASE_KEY
            
            # Sandbox Supabase
            - name: SANDBOX_SUPABASE_URL
              valueFrom:
                secretKeyRef:
                  name: moodwave-secrets
                  key: SANDBOX_SUPABASE_URL
            - name: SANDBOX_SUPABASE_KEY
              valueFrom:
                secretKeyRef:
                  name: moodwave-secrets
                  key: SANDBOX_SUPABASE_KEY
            
            # Spark configuration
            - name: SPARK_DRIVER_MEMORY
              value: "2g"
            - name: SPARK_EXECUTOR_MEMORY
              value: "2g"
            
            # Spark Metrics Configuration
            - name: SPARK_METRICS_NAMESPACE
              value: "moodwave"
            - name: SPARK_UI_PROMETHEUS_ENABLED
              value: "true"
          
          volumeMounts:
            - name: config-volume
              mountPath: /app/config.yaml
              subPath: config.yaml
            - name: checkpoint-volume
              mountPath: /tmp/spark_checkpoints
          
          resources:
            requests:
              memory: "2Gi"
              cpu: "300m"
            limits:
              memory: "3Gi"
              cpu: "1000m"
      
      volumes:
        - name: config-volume
          configMap:
            name: moodwave-config
        - name: checkpoint-volume
          emptyDir: {}
      
      # Ensure Kafka is ready before starting Spark
      initContainers:
        - name: wait-for-kafka
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Kafka to be ready..."
              until nc -z kafka-service 9092; do
                echo "Kafka not ready, waiting..."
                sleep 5
              done
              echo "Kafka is ready!"

# Optional: Use a PersistentVolumeClaim for Spark checkpoints
# This ensures checkpoint data survives pod restarts


# apiVersion: v1
# kind: PersistentVolumeClaim
# metadata:
#   name: spark-checkpoints-pvc
#   namespace: default
#   labels:
#     app: moodwave
#     component: spark-consumer
# spec:
#   accessModes:
#     - ReadWriteOnce
#   resources:
#     requests:
#       storage: 5Gi
